<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alchemy Factory Planner v95</title>
    
    <!-- Core Styling -->
    <link rel="stylesheet" href="style.css">
    
    <!-- Database and Constants -->
    <script src="alchemy_db.js"></script> 
    <script src="alchemy_constants.js"></script> 
</head>
<body>

    <header>
        <div style="display:flex; align-items:baseline;">
            <h1>Alchemy Factory Planner</h1>
            <span style="margin-left: 20px;">
                <a href="https://github.com/JoeJoesGit/AlchemyFactoryCalculator" target="_blank" class="repo-link">GitHub Repo</a>
                <span class="subtitle" onclick="showChangelog()">v95 | View Changelog</span>
            </span>
        </div>
        <div class="tabs">
            <div class="tab-btn active" onclick="switchTab('calc')">Calculator</div>
            <div class="tab-btn" onclick="switchTab('db')">Database Editor</div>
        </div>
    </header>

    <main>
        <!-- Changelog Modal -->
        <div id="changelog-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header"><h2>Changelog</h2><button class="close-modal" onclick="closeModal('changelog-modal')">&times;</button></div>
                <div style="line-height:1.6; color:#ccc;">
                    <strong>v95 - Stability & Math Overhaul</strong><br>
                    - <strong>Critical Fix:</strong> Stone Furnaces now pool slots globally across the factory (e.g., 23 Crucibles correctly ask for 8 Furnaces).<br>
                    - <strong>Fix:</strong> Summary Box "Gross/Use" logic is now accurate.<br>
                    - <strong>Fix:</strong> Internal Modules (Heat/Nutrients) now correctly contribute to Global Load stats.<br>
                    - <strong>Fix:</strong> Selecting a new item now auto-resets the Target Rate to match Belt settings.<br>
                    - <strong>Logic:</strong> Construction List "Min" now assumes merging identical outputs; "Max" counts physical nodes.<br><br>
                    <a href="https://github.com/JoeJoesGit/AlchemyFactoryCalculator/blob/main/CHANGELOG.md" target="_blank" style="color:var(--accent);">View Full History on GitHub</a>
                </div>
            </div>
        </div>

        <!-- Recipe Selection Modal -->
        <div id="recipe-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="recipe-modal-title">Select Recipe</h2>
                    <button class="close-modal" onclick="closeModal('recipe-modal')">&times;</button>
                </div>
                <div id="recipe-list"></div>
            </div>
        </div>

        <!-- View: Calculator -->
        <div id="view-calc" class="view active">
            <div class="app-grid">
                
                <!-- Column 1: Inputs & Settings -->
                <div>
                    <div class="panel">
                        <h3>Production Goal</h3>
                        <div class="input-group">
                            <label>Target Item</label>
                            <div class="combobox-container" id="targetCombobox">
                                <div class="input-wrapper" onclick="toggleCombobox()">
                                    <div id="ghost-text" class="ghost-input"></div>
                                    <input type="text" id="targetItemInput" class="real-input" placeholder="Select or Type..." autocomplete="off" oninput="filterCombobox(); updateComboIcon();" onkeydown="handleComboKey(event)" onblur="closeComboboxDelayed()">
                                    <div id="combo-btn" class="combo-arrow" onclick="handleComboIconClick(event)">â–¼</div>
                                </div>
                                <div id="combobox-list" class="combobox-list"></div>
                            </div>
                        </div>
                        <div class="input-group" style="margin-bottom:20px;">
                            <label>Belt Load Fraction</label>
                            <div class="slider-container">
                                <input type="range" id="beltSlider" min="0" max="100" step="1" oninput="updateFromSlider()">
                                <div id="sliderTicks" class="slider-ticks"></div>
                            </div>
                        </div>
                        <div class="input-group">
                            <label id="rateLabel">Rate (Items/Min)</label>
                            <div class="spinner-wrapper">
                                <button class="spinner-btn left first" onclick="adjustRate(-1)">-1</button>
                                <button class="spinner-btn left" onclick="adjustRate(-0.1)">-0.1</button>
                                <input type="number" id="targetRate" value="60" oninput="calculate()">
                                <button class="spinner-btn right" onclick="adjustRate(0.1)">+0.1</button>
                                <button class="spinner-btn right last" onclick="adjustRate(1)">+1</button>
                            </div>
                        </div>
                    </div>

                    <div class="panel">
                        <h3>Logistics</h3>
                        <div class="input-group">
                            <label>Heat Source</label>
                            <select id="fuelSelect" onchange="updateDefaultButtonState(); calculate();"></select>
                            <input type="checkbox" id="selfFeed" style="display:none;">
                            <div class="split-btn-container">
                                <button id="btnSelfFuel" class="split-btn btn-inactive-red" onclick="toggleFuel()">Self-Fuel: OFF</button>
                                <button id="btnDefFuel" class="split-btn" onclick="setDefaultFuel()">Make Default</button>
                            </div>
                        </div>
                        <div class="input-group">
                            <label>Fertilizer Source</label>
                            <select id="fertSelect" onchange="updateDefaultButtonState(); calculate();"></select>
                            <input type="checkbox" id="selfFert" style="display:none;">
                            <div class="split-btn-container">
                                <button id="btnSelfFert" class="split-btn btn-inactive-red" onclick="toggleFert()">Self-Fert: OFF</button>
                                <button id="btnDefFert" class="split-btn" onclick="setDefaultFert()">Make Default</button>
                            </div>
                        </div>
                        <div class="checkbox-row">
                            <input type="checkbox" id="showMaxCap" onchange="calculate()">
                            <label for="showMaxCap" style="display:inline; margin:0; cursor:pointer;">Show Machine Max Cap</label>
                        </div>
                    </div>
                </div>

                <!-- Column 2: Tree Results -->
                <div id="results-area">
                    <div id="summary-container"></div>
                    <div id="tree"></div>
                </div>

                <!-- Column 3: Construction List -->
                <div>
                    <div class="panel">
                        <h3>Construction List</h3>
                        <ul id="construction-list" class="build-list"></ul>
                        <div id="total-mats-container"></div>
                    </div>
                </div>

                <!-- Column 4: Upgrades -->
                <div>
                    <div class="panel">
                        <h3>Upgrades (Levels)</h3>
                        <div class="input-group">
                            <label>Belt Speed</label>
                            <div class="spinner-wrapper">
                                <button class="spinner-btn left first" onclick="adjustInput('lvlBelt', -1); updateFromSlider();">-</button>
                                <input type="number" id="lvlBelt" value="0" min="0" oninput="updateFromSlider()">
                                <button class="spinner-btn right last" onclick="adjustInput('lvlBelt', 1); updateFromSlider();">+</button>
                            </div>
                        </div>
                        <div class="input-group">
                            <label>Factory Speed</label>
                            <div class="spinner-wrapper">
                                <button class="spinner-btn left first" onclick="adjustInput('lvlSpeed', -1); calculate();">-</button>
                                <input type="number" id="lvlSpeed" value="0" min="0" oninput="calculate()">
                                <button class="spinner-btn right last" onclick="adjustInput('lvlSpeed', 1); calculate();">+</button>
                            </div>
                        </div>
                        <div class="input-group">
                            <label>Alchemy Skill</label>
                            <div class="spinner-wrapper">
                                <button class="spinner-btn left first" onclick="adjustInput('lvlAlchemy', -1); calculate();">-</button>
                                <input type="number" id="lvlAlchemy" value="0" min="0" oninput="calculate()">
                                <button class="spinner-btn right last" onclick="adjustInput('lvlAlchemy', 1); calculate();">+</button>
                            </div>
                        </div>
                        <div class="input-group">
                            <label>Fuel Efficiency</label>
                            <div class="spinner-wrapper">
                                <button class="spinner-btn left first" onclick="adjustInput('lvlFuel', -1); calculate();">-</button>
                                <input type="number" id="lvlFuel" value="0" min="0" oninput="calculate()">
                                <button class="spinner-btn right last" onclick="adjustInput('lvlFuel', 1); calculate();">+</button>
                            </div>
                        </div>
                        <div class="input-group">
                            <label>Fert Efficiency</label>
                            <div class="spinner-wrapper">
                                <button class="spinner-btn left first" onclick="adjustInput('lvlFert', -1); calculate();">-</button>
                                <input type="number" id="lvlFert" value="0" min="0" oninput="calculate()">
                                <button class="spinner-btn right last" onclick="adjustInput('lvlFert', 1); calculate();">+</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="panel">
                        <h3>Save/Reset</h3>
                        <button class="save-btn" onclick="saveSettings()">Save Upgrades</button>
                        <div style="text-align:center; margin-top:15px;">
                            <button class="reset-btn" onclick="resetToDefault()">Factory Reset</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- View: Database Editor (Updated) -->
        <div id="view-db" class="view">
            <div class="db-container">
                <!-- Sidebar with Search -->
                <div class="db-sidebar">
                    <div class="db-search">
                        <input type="text" id="db-search-input" placeholder="Search Items & Recipes..." oninput="filterDbList()">
                    </div>
                    <div id="db-list" class="db-list"></div>
                </div>

                <!-- Main Editor Area -->
                <div class="db-main" id="db-editor-area">
                    <div class="db-header">
                        <div class="db-title" id="db-editor-title">Select an Item...</div>
                        <div class="db-controls">
                            <button class="split-btn" onclick="toggleSourceView()" id="btn-source-toggle">View Source JSON</button>
                            <button class="split-btn btn-inactive-red" onclick="reportGithubIssue()" id="btn-report-issue" style="display:none; color:white !important; border-color:#d32f2f;">Report Issue</button>
                        </div>
                    </div>

                    <div id="db-form-container" class="db-form-container">
                        <!-- Dynamic Form Injected Here -->
                        <div style="color:#666; font-style:italic; text-align:center; margin-top:50px;">Select an item from the sidebar to edit.</div>
                    </div>

                    <textarea id="json-editor"></textarea>
                    
                    <div style="margin-top:20px; border-top:1px solid #444; padding-top:15px; display:flex; gap:10px;">
                        <button class="save-btn" onclick="applyChanges()" style="margin:0;">Apply Changes (Local)</button>
                        <button class="info" onclick="exportData()" style="padding:10px; background:var(--info); border:none; color:white; border-radius:4px; font-weight:bold; cursor:pointer;">Export to File</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- App Logic (Must be loaded after DB/Constants) -->
    <script src="alchemy_calc.js"></script>
    <script src="alchemy_ui.js"></script>

</body>
</html>