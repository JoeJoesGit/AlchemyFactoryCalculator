<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alchemy Factory Planner v50</title>
    <script src="alchemy_db.js"></script> 
    
    <style>
        /* --- CORE THEME --- */
        :root { 
            --bg: #1a1a1a; --text: #e0e0e0; --accent: #4caf50; 
            --panel: #2d2d2d; --border: #444; --warn: #ff9800; 
            --gold: #ffd700; --info: #2196f3; --profit: #00e676; 
            --bio: #76ff03; --fuel: #ff5722; --danger: #f44336;
            --row-id: #4fc3f7; --byproduct: #9c27b0;
        }
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 0; margin: 0; height: 100vh; display: flex; flex-direction: column; }
        
        /* --- HEADER --- */
        header { background: #111; padding: 10px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
        h1 { color: var(--accent); margin: 0; font-size: 1.2em; }
        .repo-link { color: #888; text-decoration: none; font-size: 0.9em; margin-right: 15px; border: 1px solid #444; padding: 4px 8px; border-radius: 4px; transition: 0.2s; }
        .repo-link:hover { color: #fff; border-color: #666; background: #222; }
        .subtitle { color: #888; font-size: 0.8em; margin-left: 10px; cursor: pointer; text-decoration: underline; }
        .subtitle:hover { color: #fff; }
        
        /* --- TABS --- */
        .tabs { display: flex; gap: 5px; }
        .tab-btn { background: #222; border: 1px solid var(--border); color: #888; padding: 8px 16px; cursor: pointer; border-radius: 4px; }
        .tab-btn:hover { background: #333; color: #fff; }
        .tab-btn.active { background: var(--accent); color: white; border-color: var(--accent); font-weight: bold; }

        /* --- LAYOUT --- */
        main { flex: 1; overflow: hidden; position: relative; }
        .view { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow-y: auto; padding: 20px; display: none; }
        .view.active { display: block; }
        .app-grid { display: grid; grid-template-columns: 320px 1fr 280px; gap: 20px; max-width: 1800px; margin: 0 auto; height: 100%; }
        .panel { background: var(--panel); padding: 15px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 20px; }
        .panel h3 { margin-top: 0; color: #fff; border-bottom: 1px solid #444; padding-bottom: 10px; font-size: 1.1em; }

        /* --- CONTROLS --- */
        .input-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.85em; color: #aaa; margin-bottom: 5px; }
        select { width: 100%; padding: 8px; background: #333; border: 1px solid #555; color: white; border-radius: 4px; }
        .spinner-wrapper { display: flex; align-items: stretch; width: 100%; height: 40px; }
        .spinner-btn { background: #444; border: 1px solid #555; color: white; width: 45px; cursor: pointer; font-size: 1.4em; font-weight: bold; display: flex; align-items: center; justify-content: center; transition: 0.1s; }
        .spinner-btn:hover { background: #555; }
        .spinner-btn:active { background: var(--accent); }
        .spinner-btn.minus { border-radius: 4px 0 0 4px; }
        .spinner-btn.plus { border-radius: 0 4px 4px 0; }
        input[type="number"] { flex: 1; text-align: center; font-size: 1.2em; background: #333; border: 1px solid #555; border-left: none; border-right: none; color: white; width: 10px; -moz-appearance: textfield; }
        input:disabled { opacity: 0.5; cursor: not-allowed; background: #2a2a2a; color: #aaa; }
        
        /* SPLIT BUTTONS */
        .split-btn-container { display: flex; gap: 5px; margin-top: 8px; }
        .split-btn { flex: 1; padding: 8px 4px; border: 1px solid #555; border-radius: 4px; cursor: pointer; font-size: 0.8em; font-weight: bold; transition: 0.2s; color: #ddd; background: #333; text-align: center; }
        .split-btn:hover:not(:disabled) { background: #444; color: #fff; }
        .split-btn:disabled { opacity: 0.5; cursor: default; border-color: #444; }
        .btn-active-green { background: #2e7d32 !important; border-color: #4caf50 !important; color: white !important; }
        .btn-inactive-red { background: #333 !important; color: #aaa !important; }

        /* --- LISTS --- */
        .build-list { list-style: none; padding: 0; margin: 0; }
        .build-item { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #333; font-size: 0.9em; }
        .build-item:last-child { border-bottom: none; }
        .build-name { color: #ccc; }
        .build-count { font-weight: bold; color: var(--accent); }
        .byproduct-item { color: var(--byproduct); font-style: italic; }
        
        /* --- SUMMARY BOX --- */
        .summary-box { background: #252525; border-left: 4px solid var(--accent); padding: 15px; margin-bottom: 20px; display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr; gap: 15px; }
        .stat-block { display: flex; flex-direction: column; padding-right: 15px; border-right: 1px solid #444; }
        .stat-block:last-child { border-right: none; }
        .stat-label { font-size: 0.75em; color: #aaa; text-transform: uppercase; letter-spacing: 1px; }
        .stat-value { font-size: 1.2em; font-weight: bold; color: #fff; margin-top: 5px; }
        .stat-sub { font-size: 0.85em; color: var(--warn); margin-top: 2px; }
        .gold-profit { color: var(--profit); } .gold-cost { color: var(--gold); } .net-positive { color: #69f0ae; }

        /* --- TREE NODES --- */
        .node { margin-left: 20px; padding: 6px 0; border-left: 2px solid #555; position: relative; }
        .node-content { display: flex; align-items: center; gap: 10px; background: #222; padding: 8px 12px; border-radius: 4px; border: 1px solid #333; }
        .row-id { color: var(--row-id); font-family: monospace; font-weight: bold; min-width: 25px; }
        .qty { color: var(--accent); font-weight: bold; min-width: 80px; }
        .machine-tag { background: #333; padding: 2px 6px; border-radius: 3px; font-size: 0.85em; border: 1px solid #444; color: #fff; font-weight: bold; }
        .heat-tag { color: var(--warn); font-size: 0.85em; margin-left: 5px; }
        .bio-tag { color: var(--bio); font-size: 0.85em; margin-left: 5px; }
        .cost-tag { color: var(--gold); font-size: 0.85em; margin-left: 10px; font-weight: bold; }
        .fail-tag { color: var(--danger); font-size: 0.85em; margin-left: 5px; font-weight: bold; }
        .details { font-size: 0.9em; color: #ccc; }
        .output-tag { color: var(--info); font-size: 0.85em; margin-left: 10px; font-weight: bold; border-left: 1px solid #555; padding-left: 10px; }
        .swap-btn { background: transparent; border: 1px solid #555; color: #888; width: 24px; height: 24px; border-radius: 12px; font-size: 12px; cursor: pointer; margin-left: 10px; }
        .swap-btn:hover { background: #444; color: white; border-color: #fff; }
        .section-header { margin-top: 30px; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px dashed #555; color: #888; text-transform: uppercase; letter-spacing: 1px; font-size: 0.9em; font-weight: bold; }

        /* --- MODALS & EDITOR --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: var(--panel); border: 1px solid var(--border); width: 600px; max-width: 90%; max-height: 80vh; overflow-y: auto; padding: 20px; border-radius: 8px; }
        .modal-header { display: flex; justify-content: space-between; border-bottom: 1px solid #444; padding-bottom: 10px; margin-bottom: 10px; }
        .recipe-option { background: #333; border: 1px solid #444; padding: 10px; margin-bottom: 10px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; flex-direction: column; align-items: flex-start; }
        .recipe-option.active { border-color: var(--accent); background: #2e3d30; }
        .recipe-header { font-weight: bold; font-size: 1.1em; margin-bottom: 4px; display:flex; justify-content:space-between; width:100%; }
        .recipe-details { font-size: 0.9em; color: #aaa; }
        .editor-container { max-width: 1200px; margin: 0 auto; height: 100%; display: flex; flex-direction: column; }
        #json-editor { flex: 1; background: #151515; color: #a5d6a7; font-family: 'Consolas', 'Courier New', monospace; border: 1px solid #444; padding: 15px; resize: none; line-height: 1.4; white-space: pre; }
        .editor-toolbar { margin-bottom: 10px; display: flex; gap: 10px; }
        button.save-btn { width: 100%; margin-top: 10px; background: #333; border: 1px solid var(--accent); color: var(--accent); padding: 10px; cursor: pointer; font-weight: bold; }
        button.save-btn:hover { background: var(--accent); color: white; }
        button.reset-btn { width: 100%; margin-top: 20px; background: transparent; border: 1px solid var(--danger); color: var(--danger); font-size:0.8em; padding: 5px; cursor: pointer; }
        button.reset-btn:hover { background: var(--danger); color: white; }
    </style>
</head>
<body>

    <header>
        <div style="display:flex; align-items:baseline;">
            <h1>Alchemy Factory Planner</h1>
            <span style="margin-left: 20px;">
                <a href="https://github.com/JoeJoesGit/AlchemyFactoryCalculator" target="_blank" class="repo-link">GitHub Repo</a>
                <span class="subtitle" onclick="showChangelog()">v50 | View Changelog</span>
            </span>
        </div>
        <div class="tabs">
            <div class="tab-btn active" onclick="switchTab('calc')">Calculator</div>
            <div class="tab-btn" onclick="switchTab('db')">Database Editor</div>
        </div>
    </header>

    <main>
        <div id="changelog-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header"><h2>Changelog</h2><button class="close-modal" onclick="closeModal('changelog-modal')">&times;</button></div>
                <div style="line-height:1.6; color:#ccc;">
                    <strong>v50 - Hotfix: Missing Inputs</strong><br>
                    - Restored hidden state checkboxes to fix crash on load.<br><br>
                    <strong>v49 - UI Polish</strong><br>
                    - Split-Button Logic for Fuel/Fertilizer.<br>
                    - "Nutr" units updated to V/s.<br>
                    <a href="https://github.com/JoeJoesGit/AlchemyFactoryCalculator/blob/main/CHANGELOG.md" target="_blank" style="color:var(--accent);">View Full History on GitHub</a>
                </div>
            </div>
        </div>

        <div id="recipe-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="recipe-modal-title">Select Recipe</h2>
                    <button class="close-modal" onclick="closeModal('recipe-modal')">&times;</button>
                </div>
                <div id="recipe-list"></div>
            </div>
        </div>

        <div id="view-calc" class="view active">
            <div class="app-grid">
                <div>
                    <div class="panel">
                        <h3>Production Goal</h3>
                        <div class="input-group">
                            <label>Target Item</label>
                            <select id="targetItem" onchange="calculate()"></select>
                        </div>
                        <div class="input-group">
                            <label>Belt Load</label>
                            <select id="ratePreset" onchange="applyPreset()">
                                <option value="1" selected>Full Belt (100%)</option>
                                <option value="0.6666666">2/3 Belt (~66%)</option>
                                <option value="0.5">1/2 Belt (50%)</option>
                                <option value="0.25">1/4 Belt (25%)</option>
                                <option value="0.125">1/8 Belt (12.5%)</option>
                                <option value="0.0625">1/16 Belt (6.25%)</option>
                                <option value="0.03125">1/32 Belt (3.125%)</option>
                                <option value="custom">Custom Rate</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Rate (Items/Min)</label>
                            <div class="spinner-wrapper">
                                <button class="spinner-btn minus" onclick="adjustRate(-1)">-</button>
                                <input type="number" id="targetRate" value="60" oninput="calculate()" disabled>
                                <button class="spinner-btn plus" onclick="adjustRate(1)">+</button>
                            </div>
                        </div>
                    </div>

                    <div class="panel">
                        <h3>Logistics</h3>
                        
                        <div class="input-group">
                            <label>Heat Source</label>
                            <select id="fuelSelect" onchange="updateDefaultButtonState(); calculate();"></select>
                            <input type="checkbox" id="selfFeed" style="display:none;">
                            <div class="split-btn-container">
                                <button id="btnSelfFuel" class="split-btn btn-inactive-red" onclick="toggleFuel()">Self-Fuel: OFF</button>
                                <button id="btnDefFuel" class="split-btn" onclick="setDefaultFuel()">Make Default</button>
                            </div>
                        </div>

                        <div class="input-group">
                            <label>Fertilizer Source</label>
                            <select id="fertSelect" onchange="updateDefaultButtonState(); calculate();"></select>
                            <input type="checkbox" id="selfFert" style="display:none;">
                            <div class="split-btn-container">
                                <button id="btnSelfFert" class="split-btn btn-inactive-red" onclick="toggleFert()">Self-Fert: OFF</button>
                                <button id="btnDefFert" class="split-btn" onclick="setDefaultFert()">Make Default</button>
                            </div>
                        </div>
                    </div>

                    <div class="panel">
                        <h3>Construction List</h3>
                        <ul id="construction-list" class="build-list"></ul>
                    </div>
                </div>

                <div id="results-area">
                    <div id="summary-container"></div>
                    <div id="tree"></div>
                </div>

                <div>
                    <div class="panel">
                        <h3>Upgrades (Levels)</h3>
                        <div class="input-group">
                            <label>Belt Speed</label>
                            <div class="spinner-wrapper">
                                <button class="spinner-btn minus" onclick="adjustInput('lvlBelt', -1); applyPreset();">-</button>
                                <input type="number" id="lvlBelt" value="0" min="0" oninput="applyPreset()">
                                <button class="spinner-btn plus" onclick="adjustInput('lvlBelt', 1); applyPreset();">+</button>
                            </div>
                        </div>
                        <div class="input-group">
                            <label>Factory Speed</label>
                            <div class="spinner-wrapper">
                                <button class="spinner-btn minus" onclick="adjustInput('lvlSpeed', -1); calculate();">-</button>
                                <input type="number" id="lvlSpeed" value="0" min="0" oninput="calculate()">
                                <button class="spinner-btn plus" onclick="adjustInput('lvlSpeed', 1); calculate();">+</button>
                            </div>
                        </div>
                        <div class="input-group">
                            <label>Alchemy Skill</label>
                            <div class="spinner-wrapper">
                                <button class="spinner-btn minus" onclick="adjustInput('lvlAlchemy', -1); calculate();">-</button>
                                <input type="number" id="lvlAlchemy" value="0" min="0" oninput="calculate()">
                                <button class="spinner-btn plus" onclick="adjustInput('lvlAlchemy', 1); calculate();">+</button>
                            </div>
                        </div>
                        <div class="input-group">
                            <label>Fuel Efficiency</label>
                            <div class="spinner-wrapper">
                                <button class="spinner-btn minus" onclick="adjustInput('lvlFuel', -1); calculate();">-</button>
                                <input type="number" id="lvlFuel" value="0" min="0" oninput="calculate()">
                                <button class="spinner-btn plus" onclick="adjustInput('lvlFuel', 1); calculate();">+</button>
                            </div>
                        </div>
                        <div class="input-group">
                            <label>Fert Efficiency</label>
                            <div class="spinner-wrapper">
                                <button class="spinner-btn minus" onclick="adjustInput('lvlFert', -1); calculate();">-</button>
                                <input type="number" id="lvlFert" value="0" min="0" oninput="calculate()">
                                <button class="spinner-btn plus" onclick="adjustInput('lvlFert', 1); calculate();">+</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="panel">
                        <h3>Save/Reset</h3>
                        <button class="save-btn" onclick="saveSettings()">Save Upgrades</button>
                        <div style="text-align:center; margin-top:15px;">
                            <button class="reset-btn" onclick="resetToDefault()">Factory Reset</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-db" class="view">
            <div class="editor-container">
                <div class="editor-toolbar">
                    <button class="save-btn" onclick="applyChanges()" style="width:auto; margin:0;">Apply Changes</button>
                    <button class="info" onclick="exportData()" style="padding:10px; background:var(--info); border:none; color:white; border-radius:4px; font-weight:bold; cursor:pointer;">Export to File</button>
                </div>
                <textarea id="json-editor"></textarea>
            </div>
        </div>
    </main>

<script>
let DB = null;
const STORAGE_KEY = "alchemy_factory_save_v1";
const SOURCE_KEY = "alchemy_source_v1";
let rowCounter = 0; 
let isSelfFuel = false;
let isSelfFert = false;

// --- EMBEDDED DEFAULT SOURCE (Copy of alchemy_db.js for offline fallback) ---
const DEFAULT_DB_SOURCE = `window.ALCHEMY_DB = {
    "items": {
        // --- Raw Resources ---
        "Logs": { "category": "Raw Materials", "buyPrice": 200, "heat": 10 },
        "Limestone": { "category": "Raw Materials", "buyPrice": 600 },
        "Iron Ore": { "category": "Raw Materials", "buyPrice": 1200 },
        "Coal Ore": { "category": "Raw Materials", "buyPrice": 4800, "heat": 250 },
        "Pyrite Ore": { "category": "Raw Materials", "buyPrice": 11200 },
        "Quartz Ore": { "category": "Raw Materials", "buyPrice": 44000 },
        "Meteorite": { "category": "Raw Materials", "buyPrice": 2000000 },
        "Rock Salt": { "category": "Raw Materials", "buyPrice": 9000 },
        "Volcanic Ash": { "category": "Raw Materials", "buyPrice": 5290 },
        "Gloom Fungus": { "category": "Raw Materials", "buyPrice": 46 },
        "Rotten Log": { "category": "Raw Materials", "buyPrice": 2000 },
        "World Tree Leaf": { "category": "Raw Materials", "buyPrice": 2500 },
        "World Tree Core": { "category": "Raw Materials", "buyPrice": 250000 },

        // --- Seeds ---
        "Flax Seed": { "category": "Seeds", "buyPrice": 280 },
        "Sage Seed": { "category": "Seeds", "buyPrice": 360 },
        "Red Currant Seed": { "category": "Seeds", "buyPrice": 1300 },
        "Lavender Seed": { "category": "Seeds", "buyPrice": 16000 },
        "Gentian Seed": { "category": "Seeds", "buyPrice": 64000 },
        "Chamomile Seed": { "category": "Seeds", "buyPrice": 6000 },
        "World Tree Seed": { "category": "Seeds", "buyPrice": 5000000 },

        // --- Herbs ---
        "Flax": { "category": "Herbs", "buyPrice": 2, "nutrientCost": 24 },
        "Sage": { "category": "Herbs", "buyPrice": 3, "nutrientCost": 36 },
        "Redcurrant": { "category": "Herbs", "buyPrice": 12, "nutrientCost": 144 },
        "Lavender": { "category": "Herbs", "buyPrice": 180 },
        "Chamomile": { "category": "Herbs", "buyPrice": 60 },
        "Gentian": { "category": "Herbs", "buyPrice": 500 },

        // --- Processed Materials (Solid) ---
        "Plank": { "category": "Material", "buyPrice": 1, "heat": 20 },
        "Stone": { "category": "Material", "buyPrice": 4 },
        "Sand": { "category": "Material", "buyPrice": 4 },
        "Mortar": { "category": "Material", "buyPrice": 48 },
        "Clay": { "category": "Material", "buyPrice": 20 },
        "Brick": { "category": "Material", "buyPrice": 70 },
        "Glass": { "category": "Material", "buyPrice": 75 },
        "Charcoal": { "category": "Fuel", "buyPrice": 2, "heat": 40 },
        "Coal": { "category": "Fuel", "buyPrice": 40, "heat": 540 },
        "Coke": { "category": "Fuel", "buyPrice": 30, "heat": 600 },
        "Sulfur": { "category": "Material", "buyPrice": 246 },
        "Salt": { "category": "Material", "buyPrice": 100 },
        "Obsidian": { "category": "Material", "buyPrice": 11050 },
        "Adamant": { "category": "Material", "buyPrice": 32768 },

        // --- Powders & Dusts ---
        "Charcoal Powder": { "category": "Material", "buyPrice": 2, "heat": 48 },
        "Coke Powder": { "category": "Material", "buyPrice": 30, "heat": 660 },
        "Flax Fiber": { "category": "Material", "buyPrice": 2 },
        "Sage Powder": { "category": "Material", "buyPrice": 3 },
        "Plant Ash": { "category": "Material", "buyPrice": 4 },
        "Quicklime": { "category": "Material", "buyPrice": 6 },
        "Quicklime Powder": { "category": "Material", "buyPrice": 6 },
        "Clay Powder": { "category": "Material", "buyPrice": 20 },
        "Iron Sand": { "category": "Material", "buyPrice": 15 },
        "Sulfur Powder": { "category": "Material", "buyPrice": 246 },
        "Chamomile Powder": { "category": "Material", "buyPrice": 60 },
        "Gentian Powder": { "category": "Material", "buyPrice": 500 },
        "Yeast Powder": { "category": "Material", "buyPrice": 168 },
        "Soap Powder": { "category": "Material", "buyPrice": 60 },
        "Perfumed Soap Powder": { "category": "Material", "buyPrice": 2590 },
        "Black Powder": { "category": "Potions", "buyPrice": 330, "heat": 3000 },
        
        "Impure Copper Powder": { "category": "Material", "buyPrice": 310 },
        "Copper Powder": { "category": "Material", "buyPrice": 610 },
        "Crude Silver Powder": { "category": "Material", "buyPrice": 1998 },
        "Impure Silver Powder": { "category": "Material", "buyPrice": 3997 },
        "Silver Powder": { "category": "Material", "buyPrice": 7641 },
        "Crude Gold Dust": { "category": "Material", "buyPrice": 13526 },
        "Impure Gold Dust": { "category": "Material", "buyPrice": 27053 },
        "Gold Dust": { "category": "Material", "buyPrice": 53242 },
        "Pure Gold Dust": { "category": "Material", "buyPrice": 106484 },
        "Star Dust": { "category": "Material", "buyPrice": 9207 },
        "Fairy Dust": { "category": "Material", "buyPrice": 3060 },
        "Gloom Spores": { "category": "Material", "buyPrice": 260 },

        // --- Metals ---
        "Iron Ingot": { "category": "Material", "buyPrice": 15 },
        "Copper Ingot": { "category": "Material", "buyPrice": 613 },
        "Bronze Ingot": { "category": "Material", "buyPrice": 313 },
        "Silver Ingot": { "category": "Material", "buyPrice": 7645 },
        "Gold Ingot": { "category": "Material", "buyPrice": 106492 },
        "Steel Ingot": { "category": "Material", "buyPrice": 161 },

        // --- Components ---
        "Linen Thread": { "category": "Component", "buyPrice": 6 },
        "Linen Rope": { "category": "Component", "buyPrice": 36 },
        "Large Wooden Gear": { "category": "Component", "buyPrice": 5 },
        "Small Wooden Gear": { "category": "Component", "buyPrice": 8 },
        "Iron Nails": { "category": "Component", "buyPrice": 16 },
        "Wooden Pulley": { "category": "Component", "buyPrice": 44 },
        "Steel Gear": { "category": "Component", "buyPrice": 450 },
        "Copper Bearing": { "category": "Component", "buyPrice": 300 },
        "Bronze Rivet": { "category": "Component", "buyPrice": 120 },

        // --- Goods & Relics ---
        "Linen": { "category": "Goods", "sellPrice": 165 },
        "Bandage": { "category": "Goods", "sellPrice": 350 },
        "Soap": { "category": "Goods", "sellPrice": 60 },
        "Perfumed Soap": { "category": "Goods", "sellPrice": 2590 },
        "Moonlit Soap": { "category": "Goods", "sellPrice": 995280 },
        "Pocket Watch": { "category": "Goods", "sellPrice": 1950 },
        "Silver Amulet": { "category": "Goods", "sellPrice": 48169 },
        "Copper Coin": { "category": "Currency", "buyPrice": 2 },
        "Silver Coin": { "category": "Currency", "buyPrice": 1529 },
        "Gold Coin": { "category": "Currency", "buyPrice": 106492 },
        "Crown": { "category": "Goods", "sellPrice": 1649477 },
        
        // --- Potions & Liquids ---
        "Healing Potion": { "category": "Potion", "sellPrice": 85 },
        "Vitality Potion": { "category": "Potion", "sellPrice": 330 },
        "Mana Potion": { "category": "Potion", "sellPrice": 620 }, // Called "Transformation Potion" in some files, but "ManaPotion" in ID
        "Growth Potion": { "category": "Potion", "sellPrice": 1224, "nutrientValue": 6480, "maxFertility": 2160 },
        "Blast Potion": { "category": "Potion", "sellPrice": 2557, "heat": 24000 },
        "Panacea Potion": { "category": "Potion", "sellPrice": 30126, "heat": 320000 },
        
        "Fruit Wine": { "category": "Liquid", "buyPrice": 1, "liquid": true },
        "Linseed Oil": { "category": "Liquid", "buyPrice": 0, "liquid": true },
        "Limewater": { "category": "Liquid", "buyPrice": 0, "liquid": true },
        "Brandy": { "category": "Liquid", "buyPrice": 7, "liquid": true },
        "Sulfuric Acid": { "category": "Liquid", "buyPrice": 28, "liquid": true },
        "Lavender Essential Oil": { "category": "Liquid", "buyPrice": 37, "liquid": true },
        "Gentian Nectar": { "category": "Liquid", "buyPrice": 500, "liquid": true },
        "Fairy Tear": { "category": "Liquid", "buyPrice": 3060, "liquid": true },
        "Moon Tear": { "category": "Liquid", "buyPrice": 178020, "liquid": true },
        "Mercury": { "category": "Liquid", "buyPrice": 527, "liquid": true },
        "Aqua Vitae": { "category": "Liquid", "buyPrice": 459, "liquid": true },
        "Salt Water": { "category": "Liquid", "buyPrice": 5, "liquid": true },

        // --- Essences & Catalysts ---
        "Oblivion Essence": { "category": "Essence", "buyPrice": 600 },
        "Vitality Essence": { "category": "Essence", "buyPrice": 900 },
        "Basic Fertilizer": { "category": "Fertilizer", "nutrientValue": 144, "maxFertility": 12, "buyPrice": 14 },
        "Advanced Fertilizer": { "category": "Fertilizer", "nutrientValue": 720, "maxFertility": 144, "buyPrice": 60 },
        "Unstable Catalyst": { "category": "Catalyst", "buyPrice": 1266 },
        "Fertile Catalyst": { "category": "Catalyst", "buyPrice": 4148, "nutrientValue": 24000, "maxFertility": 6000 },
        "Resonant Catalyst": { "category": "Catalyst", "buyPrice": 22949 },
        "Eternal Catalyst": { "category": "Catalyst", "buyPrice": 2004241 },
        "Philosopher's Stone": { "category": "Catalyst", "buyPrice": 1000000 },

        // --- Gems & Shards ---
        "Crude Shard": { "category": "Gem", "buyPrice": 512 },
        "Broken Shard": { "category": "Gem", "buyPrice": 1024 },
        "Dull Shard": { "category": "Gem", "buyPrice": 2048 },
        "Shattered Crystal": { "category": "Gem", "buyPrice": 4096 },
        "Crude Crystal": { "category": "Gem", "buyPrice": 8192 },
        "Polished Crystal": { "category": "Gem", "buyPrice": 16384 },
        "Adamant": { "category": "Gem", "buyPrice": 32768 },
        "Diamond": { "category": "Gem", "buyPrice": 100536 },
        "Perfect Diamond": { "category": "Gem", "buyPrice": 201072 },
        "Turquoise": { "category": "Gem", "buyPrice": 290 },
        "Malachite": { "category": "Gem", "buyPrice": 1020 },
        "Topaz": { "category": "Gem", "buyPrice": 2800 },
        "Lapis Lazuli": { "category": "Gem", "buyPrice": 32177 },
        "Ruby": { "category": "Gem", "buyPrice": 250000 },
        "Sapphire": { "category": "Gem", "buyPrice": 480000 },
        "Emerald": { "category": "Gem", "buyPrice": 700000 },

        // --- Relics ---
        "Jupiter": { "category": "Relic", "buyPrice": 30000 },
        "Saturn": { "category": "Relic", "buyPrice": 150000 },
        "Mars": { "category": "Relic", "buyPrice": 280350 },
        "Venus": { "category": "Relic", "buyPrice": 1012120 },
        "Luna": { "category": "Relic", "buyPrice": 18543420 },
        "Sol": { "category": "Relic", "buyPrice": 42025288 },
        "MercuryP": { "category": "Relic", "buyPrice": 5261390 } // Named 'Mercury' in game file but ID 814 is a relic version
    },
    
    "machines": {
        "Table Saw": { "heatCost": 0 },
        "Stone Crusher": { "heatCost": 0 },
        "Planting": { "heatCost": 0 }, // Seed Plot
        "Grinder": { "heatCost": 0 },
        "Extractor": { "heatCost": 0 },
        "Crucible": { "heatCost": 4.0, "parent": "Stone Furnace", "slotsRequired": 1 },
        "Refiner": { "heatCost": 0 },
        "Kiln": { "heatCost": 15.0, "parent": "Stone Furnace", "slotsRequired": 1 },
        "Processor": { "heatCost": 0 },
        "Assembler": { "heatCost": 0 },
        "Blender": { "heatCost": 0 },
        "Advanced Blender": { "heatCost": 0 },
        "Alembic": { "heatCost": 108.0, "parent": "Stone Furnace", "slotsRequired": 1 },
        "Advanced Alembic": { "heatCost": 270.0, "parent": "Stone Furnace", "slotsRequired": 1 },
        "Athanor": { "heatCost": 32.0, "parent": "Stone Furnace", "slotsRequired": 1 },
        "Advanced Athanor": { "heatCost": 360.0, "parent": "Stone Furnace", "slotsRequired": 1 },
        "Advanced Assembler": { "heatCost": 0 },
        "Shaper": { "heatCost": 0 },
        "Advanced Shaper": { "heatCost": 0 },
        "Arcane Shaper": { "heatCost": 0 },
        "Paradox Crucible": { "heatCost": 1200.0, "parent": "Stone Furnace", "slotsRequired": 1 },
        "Cauldron": { "heatCost": 0 },
        "Arcane Processor": { "heatCost": 0 },
        "Stone Furnace": { "heatSelf": 4.0, "slots": 3, "isGenerator": true }, // Blast Furnace in file is ID 302 'StoneFurnace' hc:4
        "Stone Stove": { "heatSelf": 1.0, "slots": 3, "isGenerator": true }, // ID 301 'StoneStove' hc:1
        "Stackable Crucible": { "heatCost": 6.0, "parent": "Stone Furnace", "slotsRequired": 1 },
        "Thermal Extractor": { "heatCost": 80.0, "parent": "Stone Furnace", "slotsRequired": 1 },
        "Enhanced Grinder": { "heatCost": 0 },
        "Iron Smelter": { "heatCost": 9.0, "parent": "Stone Furnace", "slotsRequired": 1 },
        "Nursery": { "heatCost": 0, "fertility": true },
        "World Tree Nursery": { "heatCost": 0 },
        "Knowledge Altar": { "heatCost": 0 }
    },
    
    "recipes": [
        // ID 5: Flax
        { "id": "Flax", "machine": "Planting", "inputs": { "Flax Seed": 1 }, "outputs": { "Flax": 200 }, "baseTime": 400.0 },
        // ID 6: Sage
        { "id": "Sage", "machine": "Planting", "inputs": { "Sage Seed": 1 }, "outputs": { "Sage": 180 }, "baseTime": 540.0 },
        // ID 11: Redcurrant (Base 900s for 150)
        { "id": "Redcurrant", "machine": "Planting", "inputs": { "Red Currant Seed": 1 }, "outputs": { "Redcurrant": 150 }, "baseTime": 900.0 },
        // ID 13: Lavender
        { "id": "Lavender", "machine": "Planting", "inputs": { "Lavender Seed": 1 }, "outputs": { "Lavender": 120 }, "baseTime": 1440.0 },
        // ID 15: Chamomile
        { "id": "Chamomile", "machine": "Planting", "inputs": { "Chamomile Seed": 1 }, "outputs": { "Chamomile": 140 }, "baseTime": 1120.0 },
        // ID 17: Gentian (Outputs Gentian + Nectar side product? File says 'SideProduct: GentianNectar 80')
        { "id": "Gentian", "machine": "Planting", "inputs": { "Gentian Seed": 1 }, "outputs": { "Gentian": 80, "Gentian Nectar": 80 }, "baseTime": 2160.0 },

        // ID 101: Plank
        { "id": "Plank", "machine": "Table Saw", "inputs": { "Logs": 1 }, "outputs": { "Plank": 200 }, "baseTime": 2.0 },
        // ID 102: Large Wood Gear
        { "id": "Large Wooden Gear", "machine": "Grinder", "inputs": { "Plank": 1 }, "outputs": { "Large Wooden Gear": 1 }, "baseTime": 6.0 },
        
        // ID 201: Stone (1 Limestone -> 150 Stone)
        { "id": "Stone", "machine": "Stone Crusher", "inputs": { "Limestone": 1 }, "outputs": { "Stone": 150 }, "baseTime": 3.0 },
        // ID 202: Sand
        { "id": "Sand", "machine": "Grinder", "inputs": { "Stone": 1 }, "outputs": { "Sand": 1 }, "baseTime": 12.0 },
        // ID 203: Mortar
        { "id": "Mortar", "machine": "Processor", "inputs": { "Stone": 5 }, "outputs": { "Mortar": 1 }, "baseTime": 20.0 },
        // ID 204: Flax Fiber
        { "id": "Flax Fiber", "machine": "Grinder", "inputs": { "Flax": 1 }, "outputs": { "Flax Fiber": 1 }, "baseTime": 3.0 },
        // ID 205: Linen Thread
        { "id": "Linen Thread", "machine": "Processor", "inputs": { "Flax Fiber": 3 }, "outputs": { "Linen Thread": 1 }, "baseTime": 3.0 },
        // ID 206: Linen Rope
        { "id": "Linen Rope", "machine": "Processor", "inputs": { "Linen Thread": 2 }, "outputs": { "Linen Rope": 1 }, "baseTime": 6.0 },
        // ID 207: Small Wood Gear (1 Large -> 3 Small)
        { "id": "Small Wooden Gear", "machine": "Processor", "inputs": { "Large Wooden Gear": 1 }, "outputs": { "Small Wooden Gear": 3 }, "baseTime": 12.0 },

        // ID 301: Iron Ingot (1 Ore -> 100 Ingot)
        { "id": "Iron Ingot", "machine": "Iron Smelter", "inputs": { "Iron Ore": 1 }, "outputs": { "Iron Ingot": 100 }, "baseTime": 6.0 },
        // ID 302: Nails
        { "id": "Iron Nails", "machine": "Processor", "inputs": { "Iron Ingot": 1 }, "outputs": { "Iron Nails": 3 }, "baseTime": 12.0 },
        // ID 303: Iron Sand
        { "id": "Iron Sand", "machine": "Grinder", "inputs": { "Iron Ingot": 1 }, "outputs": { "Iron Sand": 1 }, "baseTime": 30.0 },
        // ID 304: Plant Ash
        { "id": "Plant Ash", "machine": "Crucible", "inputs": { "Sage": 1 }, "outputs": { "Plant Ash": 1 }, "baseTime": 3.0 },
        // ID 305: Sage Powder
        { "id": "Sage Powder", "machine": "Grinder", "inputs": { "Sage": 1 }, "outputs": { "Sage Powder": 1 }, "baseTime": 3.0 },
        // ID 306: Healing Potion
        { "id": "Healing Potion", "machine": "Assembler", "inputs": { "Sage Powder": 6, "Flax Fiber": 6 }, "outputs": { "Healing Potion": 1 }, "baseTime": 6.0 },
        // ID 307: Linen
        { "id": "Linen", "machine": "Assembler", "inputs": { "Linen Thread": 10 }, "outputs": { "Linen": 1 }, "baseTime": 5.0 },
        // ID 308: Bandage
        { "id": "Bandage", "machine": "Assembler", "inputs": { "Linen": 1, "Healing Potion": 2 }, "outputs": { "Bandage": 1 }, "baseTime": 10.0 },

        // ID 401: Quicklime
        { "id": "Quicklime", "machine": "Crucible", "inputs": { "Stone": 1 }, "outputs": { "Quicklime": 1 }, "baseTime": 9.0 },
        // ID 402: Quicklime Powder
        { "id": "Quicklime Powder", "machine": "Grinder", "inputs": { "Quicklime": 1 }, "outputs": { "Quicklime Powder": 1 }, "baseTime": 9.0 },
        // ID 403: Charcoal
        { "id": "Charcoal", "machine": "Crucible", "inputs": { "Plank": 1 }, "outputs": { "Charcoal": 1 }, "baseTime": 4.0 },
        // ID 404: Charcoal Powder
        { "id": "Charcoal Powder", "machine": "Grinder", "inputs": { "Charcoal": 1 }, "outputs": { "Charcoal Powder": 1 }, "baseTime": 4.0 },
        // ID 405: Wood Pulley
        { "id": "Wooden Pulley", "machine": "Assembler", "inputs": { "Plank": 2, "Linen Rope": 1 }, "outputs": { "Wooden Pulley": 1 }, "baseTime": 4.0 },
        // ID 406: Clay
        { "id": "Clay", "machine": "Assembler", "inputs": { "Charcoal Powder": 2, "Sand": 4 }, "outputs": { "Clay": 1 }, "baseTime": 4.0 },
        // ID 407: Clay Powder
        { "id": "Clay Powder", "machine": "Grinder", "inputs": { "Clay": 1 }, "outputs": { "Clay Powder": 1 }, "baseTime": 4.0 },
        // ID 408: Brick
        { "id": "Brick", "machine": "Kiln", "inputs": { "Clay": 1 }, "outputs": { "Brick": 1 }, "baseTime": 6.0 },
        // ID 409: Linseed Oil
        { "id": "Linseed Oil", "machine": "Extractor", "inputs": { "Flax": 1 }, "outputs": { "Linseed Oil": 50 }, "baseTime": 2.0 },
        // ID 410: Fruit Wine
        { "id": "Fruit Wine", "machine": "Extractor", "inputs": { "Redcurrant": 1 }, "outputs": { "Fruit Wine": 10 }, "baseTime": 6.0 },
        // ID 411: Limewater
        { "id": "Limewater", "machine": "Extractor", "inputs": { "Quicklime Powder": 1 }, "outputs": { "Limewater": 30 }, "baseTime": 3.0 },
        // ID 412: Glass
        { "id": "Glass", "machine": "Kiln", "inputs": { "Sand": 6 }, "outputs": { "Glass": 1 }, "baseTime": 6.0 },
        // ID 413: Soap
        { "id": "Soap", "machine": "Blender", "inputs": { "Plant Ash": 3, "Linseed Oil": 200 }, "outputs": { "Soap": 1 }, "baseTime": 3.0 },
        // ID 414: Soap Powder
        { "id": "Soap Powder", "machine": "Grinder", "inputs": { "Soap": 1 }, "outputs": { "Soap Powder": 1 }, "baseTime": 6.0 },
        // ID 415: Vitality Potion
        { "id": "Vitality Potion", "machine": "Blender", "inputs": { "Quicklime Powder": 4, "Fruit Wine": 80 }, "outputs": { "Vitality Potion": 1 }, "baseTime": 8.0 },
        // ID 416: Basic Fertilizer
        { "id": "Basic Fertilizer", "machine": "Assembler", "inputs": { "Plant Ash": 1, "Quicklime Powder": 1 }, "outputs": { "Basic Fertilizer": 1 }, "baseTime": 4.0 },

        // ID 501: Turquoise
        { "id": "Turquoise", "machine": "Assembler", "inputs": { "Healing Potion": 2, "Sand": 12 }, "outputs": { "Turquoise": 1 }, "baseTime": 12.0 },
        // ID 502: Jupiter
        { "id": "Jupiter", "machine": "Shaper", "inputs": { "Plank": 4, "Large Wooden Gear": 6, "Wooden Pulley": 2 }, "outputs": { "Jupiter": 300 }, "baseTime": 2.0 },
        // ID 503: Coke (FAIL RATE 50% -> 2 Charcoal)
        { 
            "id": "Coke", "machine": "Athanor", 
            "inputs": { "Charcoal Powder": 6 }, "outputs": { "Coke": 1 }, 
            "baseTime": 3.0, "probability": 0.5, "failures": [{ "item": "Charcoal", "qty": 2 }] 
        },
        // ID 504: Coke Powder
        { "id": "Coke Powder", "machine": "Grinder", "inputs": { "Coke": 1 }, "outputs": { "Coke Powder": 1 }, "baseTime": 12.0 },
        // ID 505: Steel Ingot (FAIL RATE 75% -> 1 Iron Ingot)
        {
            "id": "Steel Ingot", "machine": "Athanor",
            "inputs": { "Iron Ingot": 1, "Coke Powder": 1 }, "outputs": { "Steel Ingot": 1 },
            "baseTime": 4.0, "probability": 0.25, "failures": [{ "item": "Iron Ingot", "qty": 1 }]
        },
        // ID 506: Steel Gear
        { "id": "Steel Gear", "machine": "Processor", "inputs": { "Steel Ingot": 1 }, "outputs": { "Steel Gear": 1 }, "baseTime": 16.0 },
        // ID 507: Yeast Powder
        { "id": "Yeast Powder", "machine": "Blender", "inputs": { "Soap Powder": 2, "Fruit Wine": 40 }, "outputs": { "Yeast Powder": 1 }, "baseTime": 4.0 },
        // ID 508: Mana Potion
        { "id": "Mana Potion", "machine": "Assembler", "inputs": { "Coke Powder": 2, "Gloom Spores": 1 }, "outputs": { "Mana Potion": 1 }, "baseTime": 6.0 },
        // ID 509: Gloom Fungus
        { "id": "Gloom Fungus", "machine": "Table Saw", "inputs": { "Rotten Log": 5 }, "outputs": { "Gloom Fungus": 1, "Plank": 4 }, "baseTime": 10.0 },
        // ID 510: Gloom Spores
        { "id": "Gloom Spores", "machine": "Assembler", "inputs": { "Gloom Fungus": 2, "Yeast Powder": 1 }, "outputs": { "Gloom Spores": 1 }, "baseTime": 4.0 },
        // ID 511: Advanced Fertilizer
        { "id": "Advanced Fertilizer", "machine": "Assembler", "inputs": { "Basic Fertilizer": 1, "Gloom Fungus": 1 }, "outputs": { "Advanced Fertilizer": 1 }, "baseTime": 4.0 },

        // ID 601: Chamomile Powder
        { "id": "Chamomile Powder", "machine": "Grinder", "inputs": { "Chamomile": 1 }, "outputs": { "Chamomile Powder": 1 }, "baseTime": 3.0 },
        // ID 602: Sulfur
        { "id": "Sulfur", "machine": "Iron Smelter", "inputs": { "Pyrite Ore": 4 }, "outputs": { "Sulfur": 1, "Iron Ingot": 3 }, "baseTime": 24.0 },
        // ID 603: Sulfur Powder
        { "id": "Sulfur Powder", "machine": "Grinder", "inputs": { "Sulfur": 1 }, "outputs": { "Sulfur Powder": 1 }, "baseTime": 6.0 },
        // ID 604: Coal
        { "id": "Coal", "machine": "Stone Crusher", "inputs": { "Coal Ore": 1 }, "outputs": { "Coal": 120 }, "baseTime": 3.0 },
        // ID 605: Salt (Fail Rate 66.6% -> 6 Sand)
        { 
            "id": "Salt", "machine": "Athanor", 
            "inputs": { "Charcoal Powder": 2, "Quicklime Powder": 4 }, "outputs": { "Salt": 1 }, 
            "baseTime": 6.0, "probability": 0.333333, "failures": [{ "item": "Sand", "qty": 6 }]
        },
        // ID 606: Salt Water
        { "id": "Salt Water", "machine": "Extractor", "inputs": { "Salt": 1 }, "outputs": { "Salt Water": 20 }, "baseTime": 4.0 },
        // ID 608: Copper Powder 2 (Fail 50% -> 1 Copper Powder)
        {
            "id": "Copper Powder", "machine": "Athanor", // Using final product name for convenience
            "inputs": { "Iron Sand": 6, "Soap Powder": 6 }, "outputs": { "Copper Powder": 1 },
            "baseTime": 6.0, "probability": 0.5, "failures": [{ "item": "Impure Copper Powder", "qty": 1 }]
        },
        // ID 609: Bronze Ingot
        { "id": "Bronze Ingot", "machine": "Crucible", "inputs": { "Impure Copper Powder": 1 }, "outputs": { "Bronze Ingot": 1 }, "baseTime": 12.0 },
        // ID 610: Copper Ingot
        { "id": "Copper Ingot", "machine": "Crucible", "inputs": { "Copper Powder": 1 }, "outputs": { "Copper Ingot": 1 }, "baseTime": 12.0 },
        // ID 611: Copper Coin
        { "id": "Copper Coin", "machine": "Processor", "inputs": { "Copper Ingot": 1 }, "outputs": { "Copper Coin": 300 }, "baseTime": 12.0 },
        // ID 612: Copper Bearing
        { "id": "Copper Bearing", "machine": "Processor", "inputs": { "Copper Ingot": 1 }, "outputs": { "Copper Bearing": 2 }, "baseTime": 12.0 },
        // ID 613: Bronze Rivet
        { "id": "Bronze Rivet", "machine": "Processor", "inputs": { "Bronze Ingot": 1 }, "outputs": { "Bronze Rivet": 3 }, "baseTime": 12.0 },
        // ID 614: Black Powder
        { "id": "Black Powder", "machine": "Advanced Blender", "inputs": { "Sulfur Powder": 1, "Charcoal Powder": 12, "Limewater": 150 }, "outputs": { "Black Powder": 2 }, "baseTime": 12.0 },
        // ID 615: Growth Potion
        { "id": "Growth Potion", "machine": "Advanced Blender", "inputs": { "Chamomile Powder": 2, "Clay Powder": 6, "Salt Water": 80 }, "outputs": { "Growth Potion": 1 }, "baseTime": 6.0 },
        // ID 616: Fertile Catalyst
        { "id": "Fertile Catalyst", "machine": "Advanced Assembler", "inputs": { "Chamomile Powder": 1, "Gloom Spores": 1, "Sulfur Powder": 1 }, "outputs": { "Unstable Catalyst": 1 }, "baseTime": 4.0 },
        // ID 617: Pocket Watch
        { "id": "Pocket Watch", "machine": "Advanced Assembler", "inputs": { "Steel Gear": 2, "Copper Bearing": 2, "Glass": 6 }, "outputs": { "Pocket Watch": 1 }, "baseTime": 12.0 },
        // ID 618: Malachite (Fail 50% -> 1 Shard1)
        { 
            "id": "Malachite", "machine": "Athanor", 
            "inputs": { "Copper Powder": 2, "Clay Powder": 6 }, "outputs": { "Malachite": 1 }, 
            "baseTime": 12.0, "probability": 0.5, "failures": [{ "item": "Crude Shard", "qty": 1 }]
        },
        // ID 619: Saturn
        { "id": "Saturn", "machine": "Shaper", "inputs": { "Salt": 6, "Brick": 6, "Glass": 6 }, "outputs": { "Saturn": 1 }, "baseTime": 3.0 },
        // ID 620: Mars
        { "id": "Mars", "machine": "Shaper", "inputs": { "Iron Nails": 8, "Steel Gear": 4, "Bronze Rivet": 8, "Copper Bearing": 4 }, "outputs": { "Mars": 1 }, "baseTime": 4.0 },
        
        // ID 621-626: Sand Upgrading (Skipping simple recursion for brevity, using final Shard)
        { "id": "Crude Shard", "machine": "Refiner", "inputs": { "Sand": 256 }, "outputs": { "Crude Shard": 1 }, "baseTime": 3.0 }, // Simplified chain
        
        // ID 701: Lavender Oil
        { "id": "Lavender Essential Oil", "machine": "Alembic", "inputs": { "Lavender": 3, "Linseed Oil": 300 }, "outputs": { "Lavender Essential Oil": 15 }, "baseTime": 3.0 },
        // ID 702: Brandy
        { "id": "Brandy", "machine": "Alembic", "inputs": { "Coke Powder": 5, "Fruit Wine": 100 }, "outputs": { "Brandy": 40 }, "baseTime": 5.0 },
        // ID 703: Sulfuric Acid
        { "id": "Sulfuric Acid", "machine": "Alembic", "inputs": { "Sulfur Powder": 1, "Salt Water": 60 }, "outputs": { "Sulfuric Acid": 20 }, "baseTime": 4.0 },
        // ID 704: Topaz
        { "id": "Topaz", "machine": "Blender", "inputs": { "Crude Shard": 1, "Sulfuric Acid": 30 }, "outputs": { "Topaz": 1 }, "baseTime": 12.0 },
        // ID 705: Blast Potion
        { "id": "Blast Potion", "machine": "Advanced Blender", "inputs": { "Oblivion Essence": 1, "Black Powder": 2, "Brandy": 40 }, "outputs": { "Blast Potion": 1 }, "baseTime": 6.0 },
        // ID 707: Perfumed Soap
        { "id": "Perfumed Soap", "machine": "Blender", "inputs": { "Soap Powder": 4, "Lavender Essential Oil": 30 }, "outputs": { "Perfumed Soap": 1 }, "baseTime": 8.0 },
        // ID 708: Perfumed Soap Powder
        { "id": "Perfumed Soap Powder", "machine": "Grinder", "inputs": { "Perfumed Soap": 1 }, "outputs": { "Perfumed Soap Powder": 1 }, "baseTime": 8.0 },
        // ID 709: Vitality Essence
        { "id": "Vitality Essence", "machine": "Paradox Crucible", "inputs": { "Oblivion Essence": 1 }, "outputs": { "Vitality Essence": 1 }, "baseTime": 5.0 },
        // ID 710: Venus
        { "id": "Venus", "machine": "Advanced Shaper", "inputs": { "Healing Potion": 1, "Vitality Potion": 1, "Mana Potion": 1, "Growth Potion": 1, "Blast Potion": 1, "Sulfuric Acid": 20 }, "outputs": { "Venus": 1 }, "baseTime": 6.0 },

        // ID 801: Gentian Powder
        { "id": "Gentian Powder", "machine": "Grinder", "inputs": { "Gentian": 1 }, "outputs": { "Gentian Powder": 1 }, "baseTime": 3.0 },
        // ID 804: Impure Silver Powder
        { "id": "Impure Silver Powder", "machine": "Refiner", "inputs": { "Crude Silver Powder": 2 }, "outputs": { "Impure Silver Powder": 1 }, "baseTime": 8.0 },
        // ID 805: Silver Powder (Fail 80%)
        { 
            "id": "Silver Powder", "machine": "Advanced Athanor", 
            "inputs": { "Copper Powder": 2, "Unstable Catalyst": 2, "Black Powder": 2 }, "outputs": { "Silver Powder": 1 }, 
            "baseTime": 6.4, "probability": 0.2, "failures": [{ "item": "Impure Silver Powder", "qty": 1 }]
        },
        // ID 806: Obsidian (Fail 50%)
        { 
            "id": "Obsidian", "machine": "Advanced Athanor", 
            "inputs": { "Oblivion Essence": 1, "Crude Crystal": 1, "Unstable Catalyst": 1 }, "outputs": { "Obsidian": 1 }, 
            "baseTime": 6.0, "probability": 0.5, "failures": [{ "item": "Volcanic Ash", "qty": 1 }]
        },
        // ID 808: Silver Ingot
        { "id": "Silver Ingot", "machine": "Crucible", "inputs": { "Silver Powder": 1 }, "outputs": { "Silver Ingot": 1 }, "baseTime": 16.0 },
        // ID 809: Silver Coin
        { "id": "Silver Coin", "machine": "Processor", "inputs": { "Silver Ingot": 1 }, "outputs": { "Silver Coin": 5 }, "baseTime": 16.0 },
        // ID 811: Mercury
        { "id": "Mercury", "machine": "Advanced Alembic", "inputs": { "Crude Silver Powder": 1, "Vitality Essence": 1, "Sulfuric Acid": 80 }, "outputs": { "Mercury": 10 }, "baseTime": 8.0 },
        // ID 812: Aqua Vitae
        { "id": "Aqua Vitae", "machine": "Advanced Alembic", "inputs": { "Gentian Nectar": 1, "World Tree Leaf": 1, "Brandy": 200 }, "outputs": { "Aqua Vitae": 10 }, "baseTime": 8.0 },
        // ID 813: Lapis Lazuli (Fail 66%)
        { 
            "id": "Lapis Lazuli", "machine": "Advanced Athanor", 
            "inputs": { "Impure Silver Powder": 1, "Crude Shard": 4, "Gentian Powder": 4 }, "outputs": { "Lapis Lazuli": 1 }, 
            "baseTime": 12.0, "probability": 0.333333, "failures": [{ "item": "Crude Shard", "qty": 1 }, { "item": "Crude Crystal", "qty": 1 }] 
        },
        // ID 815: Resonant Catalyst
        { "id": "Resonant Catalyst", "machine": "Advanced Blender", "inputs": { "Fertile Catalyst": 1, "Volcanic Ash": 1, "Aqua Vitae": 12 }, "outputs": { "Resonant Catalyst": 1 }, "baseTime": 8.0 },
        // ID 816: Panacea Potion
        { "id": "Panacea Potion", "machine": "Advanced Blender", "inputs": { "Fertile Catalyst": 3, "Blast Potion": 3, "Aqua Vitae": 12 }, "outputs": { "Panacea Potion": 1 }, "baseTime": 6.0 },

        // ID 902: Impure Gold Dust
        { "id": "Impure Gold Dust", "machine": "Refiner", "inputs": { "Crude Gold Dust": 2 }, "outputs": { "Impure Gold Dust": 1 }, "baseTime": 10.0 },
        // ID 903: Gold Dust (Fail 90%!)
        { 
            "id": "Gold Dust", "machine": "Advanced Athanor", 
            "inputs": { "Silver Powder": 1, "Volcanic Ash": 1, "Fertile Catalyst": 1, "Mercury": 12 }, "outputs": { "Gold Dust": 1 }, 
            "baseTime": 8.0, "probability": 0.1, "failures": [{ "item": "Crude Gold Dust", "qty": 1 }, { "item": "Impure Gold Dust", "qty": 1 }]
        },
        // ID 904: Pure Gold Dust
        { "id": "Pure Gold Dust", "machine": "Refiner", "inputs": { "Gold Dust": 2 }, "outputs": { "Pure Gold Dust": 1 }, "baseTime": 10.0 },
        // ID 905: Gold Ingot
        { "id": "Gold Ingot", "machine": "Crucible", "inputs": { "Pure Gold Dust": 1 }, "outputs": { "Gold Ingot": 1 }, "baseTime": 40.0 },
        // ID 906: Gold Coin
        { "id": "Gold Coin", "machine": "Processor", "inputs": { "Gold Ingot": 1 }, "outputs": { "Gold Coin": 1 }, "baseTime": 40.0 },
        // ID 907: Crown
        { "id": "Crown", "machine": "Advanced Assembler", "inputs": { "Gold Ingot": 3, "Ruby": 1, "Sapphire": 1 }, "outputs": { "Crown": 1 }, "baseTime": 15.0 },
        // ID 908: Eternal Catalyst
        { "id": "Eternal Catalyst", "machine": "Arcane Processor", "inputs": { "Resonant Catalyst": 15, "Philosopher's Stone": 1 }, "outputs": { "Eternal Catalyst": 1 }, "baseTime": 60.0 },
        // ID 909: Star Dust
        { "id": "Star Dust", "machine": "Arcane Processor", "inputs": { "Jupiter": 12, "Saturn": 4, "Mars": 3 }, "outputs": { "Star Dust": 2 }, "baseTime": 12.0 },
        // ID 910: Fairy Dust
        { "id": "Fairy Dust", "machine": "Arcane Processor", "inputs": { "Chamomile Powder": 1, "Gentian Powder": 1, "World Tree Leaf": 1 }, "outputs": { "Fairy Dust": 1 }, "baseTime": 4.0 },
        // ID 911: Fairy Tear
        { "id": "Fairy Tear", "machine": "Extractor", "inputs": { "Fairy Dust": 1 }, "outputs": { "Fairy Tear": 1 }, "baseTime": 4.0 },
        // ID 912: Moon Tear
        { "id": "Moon Tear", "machine": "Advanced Blender", "inputs": { "Star Dust": 16, "Fairy Tear": 10 }, "outputs": { "Moon Tear": 1 }, "baseTime": 8.0 },
        // ID 913: Moonlit Soap
        { "id": "Moonlit Soap", "machine": "Advanced Blender", "inputs": { "Perfumed Soap Powder": 2, "Moon Tear": 5 }, "outputs": { "Moonlit Soap": 1 }, "baseTime": 10.0 },
        // ID 914: Luna
        { "id": "Luna", "machine": "Arcane Shaper", "inputs": { "Steel Ingot": 1, "Bronze Ingot": 1, "Copper Ingot": 1, "Silver Ingot": 1, "Gold Ingot": 1, "Moon Tear": 1 }, "outputs": { "Luna": 1 }, "baseTime": 8.0 },
        // ID 1001: Sol
        { "id": "Sol", "machine": "Arcane Shaper", "inputs": { "Jupiter": 60, "Saturn": 20, "Mars": 15, "Venus": 40, "MercuryP": 20, "Luna": 15, "Diamond": 5, "Eternal Catalyst": 1, "World Tree Core": 1 }, "outputs": { "Sol": 1 }, "baseTime": 60.0 }
    ],

    // --- SAVE DATA ---
    "settings": {
        "beltLevel": 0,
        "speedLevel": 0,
        "alchemyLevel": 0,
        "fuelLevel": 0,
        "fertLevel": 0,
        "defaultFuel": "Plank",
        "defaultFert": "Basic Fertilizer"
    }
};`;

function init() {
    const localData = localStorage.getItem(STORAGE_KEY);
    
    // 1. Load Data (for Logic)
    if (localData) {
        try { 
            DB = JSON.parse(localData); 
            if (!DB.recipes || !DB.recipes[0].id) {
                const defaultDB = window.ALCHEMY_DB;
                const oldSettings = DB.settings || {};
                DB = JSON.parse(JSON.stringify(defaultDB)); 
                if(oldSettings.beltLevel) DB.settings = oldSettings;
                persist();
            }
        } 
        catch(e) { DB = window.ALCHEMY_DB; }
    } else {
        if (window.ALCHEMY_DB) { DB = window.ALCHEMY_DB; }
        else { alert("Error: alchemy_db.js not found!"); DB = { items: {}, recipes: [], machines: {}, settings: {} }; }
    }
    
    if(!DB.items) DB.items = {};
    if(!DB.settings) DB.settings = {};
    if(!DB.settings.preferredRecipes) DB.settings.preferredRecipes = {};

    populateSelects();
    loadSettingsToUI();
    applyPreset();
    
    // 2. Load Source Editor (Async)
    loadEditorContent(); 
}

function loadEditorContent() {
    const localSource = localStorage.getItem(SOURCE_KEY);
    const editor = document.getElementById('json-editor');
    
    if (localSource) {
        // Use saved source text (user edits)
        editor.value = localSource;
    } else {
        // Try to fetch the original source file to get comments
        fetch('alchemy_db.js')
            .then(res => {
                if(!res.ok) throw new Error("404");
                return res.text();
            })
            .then(text => {
                editor.value = text;
                // Save this initial fetch so it's ready offline next time
                localStorage.setItem(SOURCE_KEY, text);
            })
            .catch(err => {
                console.log("Fetch failed (offline/local), falling back to generated JSON.");
                // Fallback: Use the Full embedded string instead of JSON.stringify
                editor.value = DEFAULT_DB_SOURCE;
            });
    }
}

function loadSettingsToUI() {
    if (DB.settings) {
        ['lvlBelt','lvlSpeed','lvlAlchemy','lvlFuel','lvlFert'].forEach(k => {
            if(DB.settings[k] !== undefined) document.getElementById(k).value = DB.settings[k];
        });
        if(DB.settings.defaultFuel) {
            document.getElementById('fuelSelect').value = DB.settings.defaultFuel; 
        }
        if(DB.settings.defaultFert) {
            document.getElementById('fertSelect').value = DB.settings.defaultFert; 
        }
    }
    updateDefaultButtonState();
}

// --- BUTTON TOGGLES ---
function toggleFuel() {
    const btn = document.getElementById('btnSelfFuel');
    const chk = document.getElementById('selfFeed');
    chk.checked = !chk.checked;
    
    if(chk.checked) {
        btn.innerText = "Self-Fuel: ON";
        btn.classList.remove('btn-inactive-red');
        btn.classList.add('btn-active-green');
    } else {
        btn.innerText = "Self-Fuel: OFF";
        btn.classList.remove('btn-active-green');
        btn.classList.add('btn-inactive-red');
    }
    calculate();
}

function toggleFert() {
    const btn = document.getElementById('btnSelfFert');
    const chk = document.getElementById('selfFert');
    chk.checked = !chk.checked;
    
    if(chk.checked) {
        btn.innerText = "Self-Fert: ON";
        btn.classList.remove('btn-inactive-red');
        btn.classList.add('btn-active-green');
    } else {
        btn.innerText = "Self-Fert: OFF";
        btn.classList.remove('btn-active-green');
        btn.classList.add('btn-inactive-red');
    }
    calculate();
}

function setDefaultFuel() {
    const current = document.getElementById('fuelSelect').value;
    DB.settings.defaultFuel = current;
    persist();
    updateDefaultButtonState();
    alert("Default Fuel Saved: " + current);
}

function setDefaultFert() {
    const current = document.getElementById('fertSelect').value;
    DB.settings.defaultFert = current;
    persist();
    updateDefaultButtonState();
    alert("Default Fertilizer Saved: " + current);
}

function updateDefaultButtonState() {
    const curFuel = document.getElementById('fuelSelect').value;
    const defFuel = DB.settings.defaultFuel;
    const btnFuel = document.getElementById('btnDefFuel');
    
    if(curFuel === defFuel) {
        btnFuel.disabled = true;
        btnFuel.innerText = "Current Default";
    } else {
        btnFuel.disabled = false;
        btnFuel.innerText = "Make Default";
    }

    const curFert = document.getElementById('fertSelect').value;
    const defFert = DB.settings.defaultFert;
    const btnFert = document.getElementById('btnDefFert');
    
    if(curFert === defFert) {
        btnFert.disabled = true;
        btnFert.innerText = "Current Default";
    } else {
        btnFert.disabled = false;
        btnFert.innerText = "Make Default";
    }
}

function adjustInput(id, delta) {
    const el = document.getElementById(id);
    let val = parseInt(el.value) || 0;
    el.value = Math.max(0, val + delta);
}

function adjustRate(delta) {
    const el = document.getElementById('targetRate');
    if(el.disabled) return; 
    let val = parseFloat(el.value) || 0;
    el.value = (val + delta).toFixed(1);
    calculate();
}

function getRecipesFor(item) {
    if(!DB.recipes) return [];
    return DB.recipes.filter(r => r.outputs[item]);
}

function getActiveRecipe(item) {
    const candidates = getRecipesFor(item);
    if(candidates.length === 0) return null;
    if(candidates.length === 1) return candidates[0];
    const prefId = DB.settings.preferredRecipes[item];
    if(prefId) {
        const found = candidates.find(r => r.id === prefId);
        if(found) return found;
    }
    return candidates[0];
}

function openRecipeModal(item) {
    const candidates = getRecipesFor(item);
    const list = document.getElementById('recipe-list');
    list.innerHTML = '';
    document.getElementById('recipe-modal-title').innerText = `Select Recipe for ${item}`;
    const currentId = (getActiveRecipe(item) || {}).id;
    candidates.forEach(r => {
        const div = document.createElement('div');
        div.className = `recipe-option ${r.id === currentId ? 'active' : ''}`;
        
        // Build Input String
        let inputs = [];
        Object.keys(r.inputs).forEach(key => {
            inputs.push(`${r.inputs[key]}x ${key}`);
        });
        let inputStr = inputs.join(', ');

        // Build Output String (if multiple)
        let outputs = [];
        Object.keys(r.outputs).forEach(key => {
            outputs.push(`${r.outputs[key]}x ${key}`);
        });
        let outputStr = outputs.join(', ');

        div.innerHTML = `
            <div class="recipe-header">
                <strong>${r.machine}</strong> <span style="font-size:0.9em; opacity:0.8;">(${r.baseTime}s)</span>
                ${r.id === currentId ? '' : ''}
            </div>
            <div class="recipe-details">
                Input: ${inputStr}<br>
                Yields: ${outputStr}
            </div>
        `;
        div.onclick = () => { DB.settings.preferredRecipes[item] = r.id; persist(); closeModal('recipe-modal'); calculate(); };
        list.appendChild(div);
    });
    document.getElementById('recipe-modal').style.display = 'flex';
}

function closeModal(id) { document.getElementById(id).style.display = 'none'; }
function showChangelog() { document.getElementById('changelog-modal').style.display = 'flex'; }
function persist() { localStorage.setItem(STORAGE_KEY, JSON.stringify(DB)); }

function saveSettings() {
    ['lvlBelt','lvlSpeed','lvlAlchemy','lvlFuel','lvlFert'].forEach(k => {
        DB.settings[k] = parseInt(document.getElementById(k).value) || 0;
    });
    // Default fuel/fert are saved instantly by the button logic, but we re-save here just in case
    persist(); 
    alert("Settings Saved!");
}

function resetToDefault() {
    if(confirm("Factory Reset?\nThis will clear saved data and custom source edits.")) { 
        localStorage.removeItem(STORAGE_KEY); 
        localStorage.removeItem(SOURCE_KEY); 
        location.reload(); 
    }
}

function switchTab(tabName) {
    document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
    document.getElementById('view-' + tabName).classList.add('active');
    const btnIndex = tabName === 'calc' ? 0 : 1;
    document.querySelectorAll('.tab-btn')[btnIndex].classList.add('active');
}

function applyChanges() {
    const txt = document.getElementById('json-editor').value;
    try {
        // Execute the string as JS (safest way to parse full object literal with comments)
        // This updates the global window.ALCHEMY_DB object
        eval(txt); 
        
        // Update local DB reference
        DB = window.ALCHEMY_DB;
        
        // Save the Raw Text (with comments) for the editor
        localStorage.setItem(SOURCE_KEY, txt);
        
        // Save the Object Data for the calculator logic
        persist(); 
        
        init(); 
        alert("Applied!");
    } catch(e) { 
        alert("Syntax Error: " + e.message + "\n\nEnsure the text starts with 'window.ALCHEMY_DB = { ...' and ends with '};'"); 
    }
}

function exportData() {
    const txt = document.getElementById('json-editor').value;
    const blob = new Blob([txt], { type: "text/javascript" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = "alchemy_db.js"; document.body.appendChild(a); a.click(); document.body.removeChild(a);
}

function populateSelects() {
    const targetSel = document.getElementById('targetItem');
    const fuelSel = document.getElementById('fuelSelect');
    const fertSel = document.getElementById('fertSelect');
    
    targetSel.innerHTML = ''; fuelSel.innerHTML = ''; fertSel.innerHTML = '';

    const itemsByCat = {};
    const fuels = [];
    const ferts = [];

    const allItems = new Set(Object.keys(DB.items || {}));
    if(DB.recipes) DB.recipes.forEach(r => Object.keys(r.outputs).forEach(k => allItems.add(k)));

    allItems.forEach(itemName => {
        const itemDef = DB.items[itemName] || {};
        const cat = itemDef.category || "Uncategorized";
        if(!itemsByCat[cat]) itemsByCat[cat] = [];
        itemsByCat[cat].push(itemName);
        if(itemDef.heat) fuels.push({ name: itemName, heat: itemDef.heat });
        if(itemDef.nutrientValue) ferts.push({ name: itemName, val: itemDef.nutrientValue });
    });

    Object.keys(itemsByCat).sort().forEach(cat => {
        const grp = document.createElement('optgroup'); grp.label = cat;
        itemsByCat[cat].sort().forEach(i => { grp.appendChild(new Option(i, i)); });
        targetSel.appendChild(grp);
    });

    fuels.sort((a,b) => b.heat - a.heat).forEach(f => {
        const txt = `${f.name} (${f.heat} P)`;
        fuelSel.appendChild(new Option(txt, f.name));
    });

    ferts.sort((a,b) => b.val - a.val).forEach(f => {
        const txt = `${f.name} (${f.val} V)`;
        fertSel.appendChild(new Option(txt, f.name));
    });
}

function getBeltSpeed(lvl) {
    if(lvl <= 0) return 60;
    let speed = 60; speed += Math.min(lvl, 12) * 15;
    if(lvl > 12) speed += (lvl - 12) * 3;
    return speed;
}
function getSpeedMult(lvl) {
    let mult = 1.0; mult += Math.min(lvl, 12) * 0.25;
    if(lvl > 12) mult += (lvl - 12) * 0.05;
    return mult;
}
function getAlchemyMult(lvl) {
    if(lvl <= 0) return 1.0;
    let percent = 0;
    for(let i=1; i<=lvl; i++) { if(i <= 2) percent += 6; else if(i <= 8) percent += 8; else percent += 10; }
    return 1.0 + (percent / 100);
}

function applyPreset() {
    const presetVal = document.getElementById('ratePreset').value;
    const rateInput = document.getElementById('targetRate');
    if (presetVal === 'custom') { rateInput.disabled = false; } else {
        rateInput.disabled = true;
        const lvlBelt = parseInt(document.getElementById('lvlBelt').value) || 0;
        rateInput.value = (getBeltSpeed(lvlBelt) * parseFloat(presetVal)).toFixed(2);
    }
    calculate();
}

function getProductionHeatCost(item, speedMult, alchemyMult) {
    let cost = 0;
    const recipe = getActiveRecipe(item);
    if (recipe) {
        let outQty = recipe.outputs[item];
        if (recipe.machine === "Extractor" || recipe.machine === "Alembic") outQty *= alchemyMult;
        if (DB.machines[recipe.machine] && DB.machines[recipe.machine].heatCost) {
            const mach = DB.machines[recipe.machine];
            const parent = DB.machines[mach.parent];
            const pSlots = mach.parentSlots || parent.slots || 3;
            const heatPs = (mach.heatCost * speedMult) + (parent.heatSelf / pSlots); 
            cost += heatPs * ((recipe.baseTime / speedMult) / outQty);
        }
        Object.keys(recipe.inputs).forEach(k => {
            cost += getProductionHeatCost(k, speedMult, alchemyMult) * (recipe.inputs[k]/outQty);
        });
    }
    return cost;
}

function getProductionFertCost(item, fertVal, fertSpeed, speedMult, alchemyMult) {
    let cost = 0;
    const itemDef = DB.items[item] || {};
    if (itemDef.category === "Herbs" && itemDef.nutrientCost) cost += itemDef.nutrientCost;
    const recipe = getActiveRecipe(item);
    if (recipe) {
        let outQty = recipe.outputs[item];
        if (recipe.machine === "Extractor" || recipe.machine === "Alembic") outQty *= alchemyMult;
        Object.keys(recipe.inputs).forEach(k => {
            cost += getProductionFertCost(k, fertVal, fertSpeed, speedMult, alchemyMult) * (recipe.inputs[k]/outQty);
        });
    }
    return cost;
}

function formatVal(val) {
    if(val >= 1000000) return (val/1000000).toFixed(2) + 'm';
    if(val >= 10000) return (val/1000).toFixed(2) + 'k';
    return val.toFixed(2);
}

// --- MAIN CALCULATOR ---
function calculate() {
    try {
        if(!DB || !DB.recipes) return;

        rowCounter = 0; 

        const targetItem = document.getElementById('targetItem').value;
        const targetRate = parseFloat(document.getElementById('targetRate').value) || 0;
        const selectedFuel = document.getElementById('fuelSelect').value;
        const selfFeed = document.getElementById('selfFeed').checked;
        const selectedFert = document.getElementById('fertSelect').value;
        const selfFert = document.getElementById('selfFert').checked;

        const lvlSpeed = parseInt(document.getElementById('lvlSpeed').value) || 0;
        const lvlBelt = parseInt(document.getElementById('lvlBelt').value) || 0;
        const lvlFuel = parseInt(document.getElementById('lvlFuel').value) || 0;
        const lvlAlchemy = parseInt(document.getElementById('lvlAlchemy').value) || 0;
        const lvlFert = parseInt(document.getElementById('lvlFert').value) || 0;

        const speedMult = getSpeedMult(lvlSpeed);
        const alchemyMult = getAlchemyMult(lvlAlchemy);
        const fuelMult = 1 + (lvlFuel * 0.10); 
        const fertMult = 1 + (lvlFert * 0.10); 
        const beltSpeed = getBeltSpeed(lvlBelt);

        const treeContainer = document.getElementById('tree');
        treeContainer.innerHTML = '';
        
        // --- NET ENERGY CALC ---
        const fuelDef = DB.items[selectedFuel] || {};
        let netFuelEnergy = (fuelDef.heat || 10) * fuelMult;
        const grossFuelEnergy = netFuelEnergy; 
        
        if (selfFeed) {
            const fuelCost = getProductionHeatCost(selectedFuel, speedMult, alchemyMult);
            netFuelEnergy -= fuelCost;
        }
        if(netFuelEnergy <= 0) netFuelEnergy = 0.1; 

        const fertDef = DB.items[selectedFert] || { nutrientValue: 144, maxFertility: 12 };
        let netFertVal = fertDef.nutrientValue * fertMult;
        const grossFertVal = netFertVal;
        if (selfFert) {
            const fertCost = getProductionFertCost(selectedFert, netFertVal, fertDef.maxFertility, speedMult, alchemyMult);
            netFertVal -= fertCost;
        }
        if(netFertVal <= 0) netFertVal = 0.1;

        // --- ACCUMULATORS ---
        let globalFuelDemandItems = 0; 
        let globalFertDemandItems = 0; 
        let globalHeatLoad = 0; 
        let globalBioLoad = 0; 
        let globalCostPerMin = 0;
        let totalMachineCounts = {}; 
        let totalFurnaces = 0;
        let totalByproducts = {};

        function addMachineCount(name, count) {
            if(!totalMachineCounts[name]) totalMachineCounts[name] = 0;
            totalMachineCounts[name] += count;
        }

        // --- DEFINE GROSS RATE ---
        let grossRate = targetRate;
        if (selfFeed && targetItem === selectedFuel) {
            const rawFuelEnergy = (fuelDef.heat || 10) * fuelMult;
            grossRate = targetRate * (rawFuelEnergy / netFuelEnergy);
        }
        if (selfFert && targetItem === selectedFert) {
            const rawFertVal = fertDef.nutrientValue * fertMult;
            grossRate = targetRate * (rawFertVal / netFertVal);
        }

        const targetItemDef = DB.items[targetItem] || {};

        function buildNode(item, rate, isInternalModule) {
            const div = document.createElement('div');
            div.className = 'node';
            const itemDef = DB.items[item] || {};
            
            rowCounter++; 
            const myRowID = rowCounter;

            let innerHTML = '';
            let ingredientChildren = [];
            let outputTag = "";
            
            let isFuel = (item === selectedFuel);
            let isFert = (item === selectedFert);
            
            if(isFuel) {
                const totalP = (rate * (fuelDef.heat || 10) * fuelMult) / 60;
                outputTag = `<span class="output-tag">Output: ${formatVal(totalP)} P/s</span>`;
            } else if (isFert) {
                const totalV = (rate * fertDef.nutrientValue * fertMult) / 60;
                outputTag = `<span class="output-tag">Output: ${formatVal(totalV)} V/s</span>`;
            }

            let stopRecursion = false;
            if (!isInternalModule) {
                if (isFuel && selfFeed && item !== targetItem) stopRecursion = true;
                if (isFert && selfFert && item !== targetItem) stopRecursion = true;
            }

            if (itemDef.category === "Herbs" && itemDef.nutrientCost) {
                const fertilitySpeed = (fertDef.maxFertility || 12); 
                const timePerItem = itemDef.nutrientCost / fertilitySpeed; 
                const itemsPerMinPerMachine = (60 / timePerItem) * speedMult; 
                const machinesNeeded = rate / itemsPerMinPerMachine;
                addMachineCount("Nursery", machinesNeeded);

                const totalNutrientsNeeded = rate * itemDef.nutrientCost; 
                const itemsNeeded = totalNutrientsNeeded / grossFertVal; 
                
                if (!isInternalModule) {
                    globalFertDemandItems += itemsNeeded;
                    globalBioLoad += (totalNutrientsNeeded / 60); // V/s
                }

                const bioTag = `<span class="bio-tag">Nutr: ${formatVal(totalNutrientsNeeded / 60)} V/s, Needs ${itemsNeeded.toFixed(1)}/m ${selectedFert}</span>`;

                innerHTML = `<div class="node-content">
                    <span class="row-id">${myRowID})</span>
                    <span class="qty">${rate.toFixed(1)}/m</span>
                    <strong>${item}</strong>
                    <span class="machine-tag">${Math.ceil(machinesNeeded)} Nursery</span>
                    ${bioTag} ${outputTag}
                </div>`;
            } 
            else {
                const recipe = getActiveRecipe(item);
                if (!recipe) {
                    let costHtml = "";
                    if(itemDef.buyPrice) {
                        const costPerMin = rate * itemDef.buyPrice;
                        globalCostPerMin += costPerMin;
                        costHtml = `<span class="cost-tag">${Math.ceil(costPerMin).toLocaleString()} G/m</span>`;
                    }
                    innerHTML = `<div class="node-content">
                        <span class="row-id">${myRowID})</span>
                        <span class="qty">${rate.toFixed(1)}/m</span>
                        <strong>${item}</strong>
                        <span class="details">(Raw Input)</span>
                        ${costHtml} ${outputTag}
                    </div>`;
                } else {
                    // --- FAIL RATE LOGIC ---
                    let probability = recipe.probability || 1.0;
                    // Adjusted Rate needed to get 'rate' successes
                    let attemptsRate = rate / probability;
                    
                    let outputQty = recipe.outputs[item];
                    if (recipe.machine === "Extractor" || recipe.machine === "Alembic") {
                        outputQty = outputQty * alchemyMult;
                    }

                    const itemsPerMinPerMachine = (60 / recipe.baseTime * outputQty) * speedMult;
                    const machinesNeeded = attemptsRate / itemsPerMinPerMachine;
                    addMachineCount(recipe.machine, machinesNeeded);

                    // --- BYPRODUCTS ---
                    if (recipe.failures && probability < 1.0) {
                        let failureCount = attemptsRate - rate;
                        recipe.failures.forEach(fail => {
                            let byproductAmount = failureCount * fail.qty;
                            if(!totalByproducts[fail.item]) totalByproducts[fail.item] = 0;
                            totalByproducts[fail.item] += byproductAmount;
                        });
                    }

                    let heatTag = "";
                    let failTag = (probability < 1.0) ? `<span class="fail-tag">(${(probability*100).toFixed(0)}% Chance)</span>` : "";
                    
                    if (DB.machines[recipe.machine] && DB.machines[recipe.machine].heatCost) {
                        const machineDef = DB.machines[recipe.machine];
                        const parentDef = DB.machines[machineDef.parent];
                        const slotsReq = machineDef.slotsRequired || 1; 
                        const pSlots = machineDef.parentSlots || parentDef.slots || 3;
                        
                        const activeHeatPerMachine = machineDef.heatCost * speedMult;
                        const parentsNeeded = Math.ceil(machinesNeeded / (pSlots / slotsReq));
                        const totalHeatPs = (parentsNeeded * parentDef.heatSelf) + (machinesNeeded * activeHeatPerMachine);
                        
                        totalFurnaces += parentsNeeded;
                        if (!isInternalModule) globalHeatLoad += totalHeatPs;

                        const itemsNeeded = (totalHeatPs * 60) / grossFuelEnergy;
                        if (!isInternalModule) globalFuelDemandItems += itemsNeeded;

                        heatTag = `<span class="heat-tag">Heat: ${totalHeatPs.toFixed(1)} P/s, Needs ${itemsNeeded.toFixed(1)}/m ${selectedFuel}</span>`;
                    }

                    let swapHtml = "";
                    const alternates = getRecipesFor(item);
                    if(alternates.length > 1) {
                        swapHtml = `<button class="swap-btn" onclick="openRecipeModal('${item}')" title="Swap Recipe"></button>`;
                    }

                    innerHTML = `<div class="node-content">
                        <span class="row-id">${myRowID})</span>
                        <span class="qty">${rate.toFixed(1)}/m</span>
                        <strong>${item}</strong> ${swapHtml} ${failTag}
                        <span class="machine-tag">${Math.ceil(machinesNeeded)} ${recipe.machine}s</span>
                        ${heatTag} ${outputTag}
                    </div>`;

                    if (!stopRecursion) {
                        Object.keys(recipe.inputs).forEach(inputName => {
                            const inputQty = recipe.inputs[inputName];
                            // Input is needed for EVERY ATTEMPT, not just successes
                            const requiredInputRate = (attemptsRate / outputQty) * inputQty;
                            ingredientChildren.push({ type: 'input', item: inputName, rate: requiredInputRate });
                        });
                    }
                }
            }

            div.innerHTML = innerHTML;
            ingredientChildren.forEach(child => {
                div.appendChild(buildNode(child.item, child.rate, isInternalModule));
            });
            return div;
        }

        // --- 1. RENDER MAIN TREE ---
        if(targetItem) {
            const header = document.createElement('div');
            header.className = 'section-header';
            header.innerText = `--- Primary Production Chain (${targetItem}) ---`;
            treeContainer.appendChild(header);
            treeContainer.appendChild(buildNode(targetItem, grossRate, false));
        }

        // --- 2. INTERNAL MODULES ---
        if (selfFert && globalFertDemandItems > 0) {
            const fertEff = netFertVal / grossFertVal;
            const grossFertNeeded = globalFertDemandItems / fertEff;

            if (targetItem === selectedFert) {
                const note = document.createElement('div');
                note.innerHTML = `<div class="node" style="margin-top:20px; color:#aaa; font-style:italic;">
                    Internal Nutrient Source: <strong>${selectedFert}</strong> (Supplied by Main Output)<br>
                    Total Required: ${grossFertNeeded.toFixed(1)}/m
                </div>`;
                treeContainer.appendChild(note);
            } else {
                const header = document.createElement('div');
                header.className = 'section-header';
                header.innerText = `--- Internal Nutrient Module (${selectedFert}) ---`;
                treeContainer.appendChild(header);
                rowCounter = 0; 
                treeContainer.appendChild(buildNode(selectedFert, grossFertNeeded, true));
            }
        }

        if (selfFeed && globalFuelDemandItems > 0) {
            const fuelEff = netFuelEnergy / grossFuelEnergy;
            const grossFuelNeeded = globalFuelDemandItems / fuelEff;

            if (targetItem === selectedFuel) {
                const note = document.createElement('div');
                note.innerHTML = `<div class="node" style="margin-top:20px; color:#aaa; font-style:italic;">
                    Internal Fuel Source: <strong>${selectedFuel}</strong> (Supplied by Main Output)<br>
                    Total Required: ${grossFuelNeeded.toFixed(1)}/m
                </div>`;
                treeContainer.appendChild(note);
            } else {
                const header = document.createElement('div');
                header.className = 'section-header';
                header.innerText = `--- Internal Heat Module (${selectedFuel}) ---`;
                treeContainer.appendChild(header);
                
                rowCounter = 0; 
                treeContainer.appendChild(buildNode(selectedFuel, grossFuelNeeded, true));
            }
        }

        // --- 3. EXTERNAL INPUTS ---
        const extHeader = document.createElement('div');
        extHeader.className = 'section-header';
        extHeader.innerText = `--- External Inputs ---`;
        treeContainer.appendChild(extHeader);

        const extDiv = document.createElement('div');
        extDiv.className = 'node';
        let extHTML = '';

        extHTML += `<div class="node-content" style="margin-bottom:5px;">
            <span class="qty" style="color:var(--gold)">${Math.ceil(globalCostPerMin).toLocaleString()} G/m</span>
            <strong>Raw Material Cost</strong>
        </div>`;

        if (!selfFeed && globalFuelDemandItems > 0) {
            extHTML += `<div class="node-content" style="margin-bottom:5px;">
                <span class="qty" style="color:var(--fuel)">${globalFuelDemandItems.toFixed(1)}/m</span>
                <strong>${selectedFuel}</strong> (Fuel Import)
            </div>`;
        }

        if (!selfFert && globalFertDemandItems > 0) {
            extHTML += `<div class="node-content" style="margin-bottom:5px;">
                <span class="qty" style="color:var(--bio)">${globalFertDemandItems.toFixed(1)}/m</span>
                <strong>${selectedFert}</strong> (Fertilizer Import)
            </div>`;
        }
        extDiv.innerHTML = extHTML;
        treeContainer.appendChild(extDiv);


        // --- LISTS & SUMMARY ---
        const buildList = document.getElementById('construction-list');
        buildList.innerHTML = '';
        
        const sortedMachines = Object.keys(totalMachineCounts).sort();
        sortedMachines.forEach(m => {
            const count = totalMachineCounts[m];
            if(count <= 0.01) return;
            const li = document.createElement('li');
            li.className = 'build-item';
            li.innerHTML = `<span class="build-name">${m}</span> <span class="build-count">${Math.ceil(count)}</span>`;
            buildList.appendChild(li);
        });
        if(totalFurnaces > 0) {
            const li = document.createElement('li');
            li.className = 'build-item';
            li.style.borderTop = "1px dashed #555";
            li.innerHTML = `<span class="build-name">Stone Furnace (Minimum)</span> <span class="build-count" style="color:#ff9800">${totalFurnaces}</span>`;
            buildList.appendChild(li);
        }

        // Byproducts
        const sortedByproducts = Object.keys(totalByproducts).sort();
        if(sortedByproducts.length > 0) {
            const headerLi = document.createElement('li');
            headerLi.style.cssText = "margin-top:15px; color:#888; font-weight:bold; border-bottom:1px solid #444; padding-bottom:5px;";
            headerLi.innerText = "Byproducts (Waste)";
            buildList.appendChild(headerLi);
            
            sortedByproducts.forEach(item => {
                const count = totalByproducts[item];
                if(count <= 0.01) return;
                const li = document.createElement('li');
                li.className = 'build-item';
                li.innerHTML = `<span class="build-name byproduct-item">${item}</span> <span class="build-count">${formatVal(count)}/m</span>`;
                buildList.appendChild(li);
            });
        }

        let internalHeat = selfFeed ? globalHeatLoad : 0;
        let externalHeat = !selfFeed ? globalHeatLoad : 0;
        let internalBio = selfFert ? globalBioLoad : 0;
        let externalBio = !selfFert ? globalBioLoad : 0;

        let profitHtml = "";
        if (targetItemDef.sellPrice) {
            const revenuePerMin = targetRate * targetItemDef.sellPrice;
            const profit = revenuePerMin - globalCostPerMin;
            profitHtml = `<div class="stat-block"><span class="stat-label">Projected Profit</span><span class="stat-value ${profit >= 0 ? 'gold-profit' : 'gold-cost'}">${Math.floor(profit).toLocaleString()} G/m</span></div>`;
        } else {
            profitHtml = `<div class="stat-block"><span class="stat-label">Total Raw Cost</span><span class="stat-value gold-cost">${Math.ceil(globalCostPerMin).toLocaleString()} G/m</span></div>`;
        }

        let deductionText = [];
        if (selfFeed && targetItem === selectedFuel) {
            deductionText.push(`Gross: ${grossRate.toFixed(1)}`);
            deductionText.push(`Use: ${(grossRate - targetRate).toFixed(1)}`);
        }
        if (selfFert && targetItem === selectedFert) {
            deductionText.push(`Gross: ${grossRate.toFixed(1)}`);
            deductionText.push(`Use: ${(grossRate - targetRate).toFixed(1)}`);
        }

        document.getElementById('summary-container').innerHTML = `
            <div class="summary-box">
                <div class="stat-block">
                    <span class="stat-label">Net Output</span>
                    <span class="stat-value ${targetRate >= 0 ? 'net-positive' : 'net-warning'}">${targetRate.toFixed(1)} / min</span>
                    ${deductionText.length > 0 ? `<span class="stat-sub" style="font-size:0.75em">${deductionText.join('<br>')}</span>` : ''}
                </div>
                <div class="stat-block">
                    <span class="stat-label">Internal Load</span>
                    <span class="stat-value" style="font-size:0.9em; color:var(--fuel);">Heat: ${internalHeat.toFixed(1)} P/s</span>
                    <span class="stat-value" style="font-size:0.9em; color:var(--bio);">Nutr: ${formatVal(internalBio)} V/s</span>
                </div>
                <div class="stat-block">
                    <span class="stat-label">External Load</span>
                    <span class="stat-value" style="font-size:0.9em; color:var(--fuel);">Heat: ${externalHeat.toFixed(1)} P/s</span>
                    <span class="stat-value" style="font-size:0.9em; color:var(--bio);">Nutr: ${formatVal(externalBio)} V/s</span>
                </div>
                ${profitHtml}
                <div class="stat-block">
                    <span class="stat-label">Belt Usage (Net)</span>
                    <span class="stat-value" style="font-size:1.1em; color:${targetRate > beltSpeed ? '#ff5252' : '#aaa'};">${(targetRate/beltSpeed * 100).toFixed(0)}%</span>
                    <span class="stat-sub">Cap: ${beltSpeed}/m</span>
                </div>
            </div>`;
    } catch(e) {
        console.error(e);
        alert("Calculation Error: " + e.message + "\n\nTry clicking 'Factory Reset' to fix outdated data.");
    }
}

init();
</script>
</body>
</html>